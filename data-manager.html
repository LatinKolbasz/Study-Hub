<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adatkezeles - Study Hub</title>
    <link rel="stylesheet" href="index.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: white;
            padding: 2rem;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 2rem; }
        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(10px);
        }
        .card h2 { margin-bottom: 1rem; color: #6366f1; }
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem 0;
            transition: all 0.3s;
        }
        .btn-primary { background: #6366f1; color: white; }
        .btn-primary:hover { background: #5558e3; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        textarea {
            width: 100%;
            height: 150px;
            border-radius: 8px;
            padding: 1rem;
            font-family: monospace;
            background: rgba(0,0,0,0.3);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            margin: 1rem 0;
        }
        .info {
            background: rgba(99, 102, 241, 0.2);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        .back-link {
            color: white;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Vissza a fooldalra</a>
        
        <h1>üì¶ Adatkezeles</h1>
        
        <div class="card">
            <h2>üì§ Adatok exportalasa</h2>
            <p>Toltsd le az osszes adatodat JSON formatumban:</p>
            <div class="info">
                <strong>üîí Mit tartalmaz:</strong>
                <ul>
                    <li>Jegyek (gradeTracker)</li>
                    <li>Beadandok (assignments)</li>
                    <li>Kvizek (quizzes)</li>
                    <li>Study Timer beallitasok es statisztikak</li>
                </ul>
            </div>
            <button class="btn btn-primary" onclick="exportData()">üì• Letoltes</button>
        </div>
        
        <div class="card">
            <h2>üì• Adatok importalasa</h2>
            <p>Masold be a korabban exportalt JSON adatokat:</p>
            
            <!-- F√°jlb√≥l import√°l√°s -->
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem;">üìÅ Vagy t√∂lts fel f√°jlb√≥l:</label>
                <input type="file" id="importFile" accept=".json" style="color: white;">
                <button class="btn btn-success" onclick="importFromFile()" style="margin-left: 0.5rem;">üìÇ Bet√∂lt√©s f√°jlb√≥l</button>
            </div>
            
            <p style="margin-top: 1rem;">üìã Vagy m√°sold be a sz√∂veget:</p>
            <textarea id="importData" placeholder="Paste exported JSON here..."></textarea>
            <button class="btn btn-success" onclick="importData()">üì§ Importalas</button>
            <div class="info">
                <strong>‚ö†Ô∏è Figyelmeztetes:</strong> Az import felulirja a jelenlegi adatokat!
            </div>
        </div>
        
        <div class="card">
            <h2>üóëÔ∏è Adatok torlese</h2>
            <p>Torolj minden helyi adatot:</p>
            <button class="btn btn-danger" onclick="clearAllData()">üîÑ Osszes torlese</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBNdafBY_6jaIDiaHJ6afm1yvFlFZsdspc",
            authDomain: "study-hub-4debf.firebaseapp.com",
            projectId: "study-hub-4debf",
            storageBucket: "study-hub-4debf.firebasestorage.app",
            messagingSenderId: "681045719671",
            appId: "1:681045719671:web:8d9c665212610578f96472",
            measurementId: "G-PGVQL7C70N"
        };
        firebase.initializeApp(firebaseConfig);
        firebase.firestore().settings({ experimentalForceLongPolling: false, merge: true });
    </script>
    <script src="utils/auth.js"></script>
    <script>
        // NEMË¶ÅÊ±ÇÁöÑ bejelentkezes - mindenki elerheti az export/import-ot
        // Igy a regi adatokat is ki lehet menteni
        
        function exportData() {
            // Elso: probald meg a regi formatumot (bejelentkezes nelkul)
            var oldData = localStorage.getItem('gradeTracker');
            var oldAssignments = localStorage.getItem('assignments');
            var oldQuizzes = localStorage.getItem('quizzes');
            
            var hasOldData = oldData || oldAssignments || oldQuizzes;
            
            if (hasOldData && !confirm('üîç Talaltam regi adatokat (bejelentkezes elolrol). Ezeket is exportaljuk?')) {
                return;
            }
            
            var username = 'migrated';
            var prefix = '';
            
            // Ha van bejelentkezve felhasznalo, hasznald azt
            if (window.authManager && window.authManager.currentUser) {
                username = window.authManager.currentUser.username;
                prefix = 'studyhub_' + window.authManager.simpleHash(username) + '_';
            } else {
                // Regi formatum - prefix nelkul
                username = 'regi_adatok';
            }
            
            var data = {
                exportDate: new Date().toISOString(),
                username: username,
                version: '1.0',
                isMigration: true,
                gradeTracker: null,
                assignments: null,
                quizzes: null,
                timerSettings: null,
                timerStats: null
            };
            
            // Uj formatum (felhasznaloval)
            if (prefix) {
                var gradeData = localStorage.getItem(prefix + 'gradeTracker');
                if (gradeData) data.gradeTracker = JSON.parse(gradeData);
                
                var assignData = localStorage.getItem(prefix + 'assignments');
                if (assignData) data.assignments = JSON.parse(assignData);
                
                var quizData = localStorage.getItem(prefix + 'quizzes');
                if (quizData) data.quizzes = JSON.parse(quizData);
            }
            
            // Regi formatum (prefix nelkul) - migraciohoz
            if (hasOldData) {
                if (oldData) data.gradeTracker = JSON.parse(oldData);
                if (oldAssignments) data.assignments = JSON.parse(oldAssignments);
                if (oldQuizzes) data.quizzes = JSON.parse(oldQuizzes);
                
                data.isMigration = true;
                data.migrationNote = 'Ez a regi adatok migracioja - a bejelentkezesi rendszer elso hasznalata elott';
            }
            
            if (!data.gradeTracker && !data.assignments && !data.quizzes) {
                alert('‚ùå Nincs exportalhato adat!');
                return;
            }
            
            // Let√∂lt√©s
            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'studyhub_export_' + username + '_' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Adatok sikeresen exportalva!');
        }
        
        // Seg√©df√ºggv√©ny: double-encoded JSON string jav√≠t√°sa
        function fixDoubleEncoded(data) {
            var fixed = false;
            
            // gradeTracker
            if (data.gradeTracker && typeof data.gradeTracker === 'string') {
                try {
                    data.gradeTracker = JSON.parse(data.gradeTracker);
                    console.log('‚úÖ gradeTracker double-encoded jav√≠tva');
                    fixed = true;
                } catch(e) {
                    console.warn('‚ö†Ô∏è gradeTracker nem volt √©rv√©nyes JSON string:', e);
                }
            }
            
            // assignments
            if (data.assignments && typeof data.assignments === 'string') {
                try {
                    data.assignments = JSON.parse(data.assignments);
                    console.log('‚úÖ assignments double-encoded jav√≠tva');
                    fixed = true;
                } catch(e) {
                    console.warn('‚ö†Ô∏è assignments nem volt √©rv√©nyes JSON string:', e);
                }
            }
            
            // quizzes
            if (data.quizzes && typeof data.quizzes === 'string') {
                try {
                    data.quizzes = JSON.parse(data.quizzes);
                    console.log('‚úÖ quizzes double-encoded jav√≠tva');
                    fixed = true;
                } catch(e) {
                    console.warn('‚ö†Ô∏è quizzes nem volt √©rv√©nyes JSON string:', e);
                }
            }
            
            return fixed;
        }
        
        // F√°jlb√≥l import√°l√°s
        function importFromFile() {
            var fileInput = document.getElementById('importFile');
            var file = fileInput.files[0];
            
            if (!file) {
                alert('‚ùå K√©rlek, v√°lassz egy f√°jlt!');
                return;
            }
            
            var reader = new FileReader();
            reader.onload = function(e) {
                var content = e.target.result;
                console.log('F√°jl beolvasva:', content.length, 'karakter');
                
                // √úres f√°jl ellen≈ërz√©s
                if (!content || content.trim().length === 0) {
                    alert('‚ùå A f√°jl √ºres! Pr√≥b√°ld meg a m√°sik m√≥dszert (m√°sol√°s-beilleszt√©s).');
                    return;
                }
                
                try {
                    var data = JSON.parse(content);
                    console.log('JSON parse OK, kulcsok:', Object.keys(data));
                    
                    // Ellen≈ërizz√ºk a form√°tumot
                    var isValidFormat = data.version || data.gradeTracker || data.assignments || data.grades;
                    
                    if (!isValidFormat) {
                        alert('‚ùå Ismeretlen form√°tum! A f√°jl nem t≈±nik √©rv√©nyes exportnak.');
                        return;
                    }
                    
                    // Double-encoded jav√≠t√°s
                    fixDoubleEncoded(data);
                    
                    if (!confirm('‚ö†Ô∏è Ez fel√ºl√≠rhatja a jelenlegi adatokat! Biztosan folytatod?')) {
                        return;
                    }
                    
                    var targetPrefix = '';
                    
                    // Debug: ellen≈ërizz√ºk, hogy a hash megegyezik-e
                    // A grade-tracker.js √©s auth.js k√ºl√∂nb√∂z≈ë hash-t haszn√°l!
                    // grade-tracker.js: toString(36)
                    // auth.js: toString(16)
                    
                    if (window.authManager && window.authManager.currentUser) {
                        const username = window.authManager.currentUser.username;
                        // Ugyanazt a hash-t haszn√°ljuk mint a grade-tracker.js
                        let hash = 0;
                        for (let i = 0; i < username.length; i++) {
                            const char = username.charCodeAt(i);
                            hash = ((hash << 5) - hash) + char;
                            hash = hash & hash;
                        }
                        const hashStr = Math.abs(hash).toString(36);
                        targetPrefix = 'studyhub_' + hashStr + '_';
                        console.log('üîê Username:', username, 'Hash:', hashStr, 'Prefix:', targetPrefix);
                    }
                    
                    var importedCount = 0;
                    
                    // Debug: n√©zz√ºk meg mi van az adatban
                    console.log('üì• Import data:', JSON.stringify(data).substring(0, 200) + '...');
                    console.log('üìÅ Target prefix:', targetPrefix);
                    
                    // 1. √öj form√°tum: data.gradeTracker - k√∂zvetlen√ºl mentj√ºk a tartalmat
                    if (data.gradeTracker) {
                        // A gradeTracker objektum tartalm√°t mentj√ºk k√∂zvetlen√ºl
                        const storageKey = targetPrefix + 'gradeTracker';
                        localStorage.setItem(storageKey, JSON.stringify(data.gradeTracker));
                        console.log('‚úÖ Mentve:', storageKey, '- jegyek:', data.gradeTracker.grades?.length || 0);
                        importedCount++;
                    }
                    
                    // 2. R√©gi form√°tum: k√∂zvetlen grades t√∂mb
                    if (data.grades && !data.gradeTracker) {
                        localStorage.setItem(targetPrefix + 'gradeTracker', JSON.stringify(data));
                        importedCount++;
                    }
                    if (data.assignments) {
                        localStorage.setItem(targetPrefix + 'assignments', JSON.stringify(data.assignments));
                        importedCount++;
                    }
                    if (data.quizzes) {
                        localStorage.setItem(targetPrefix + 'quizzes', JSON.stringify(data.quizzes));
                        importedCount++;
                    }
                    if (data.timerSettings) {
                        localStorage.setItem(targetPrefix + 'timerSettings', JSON.stringify(data.timerSettings));
                        importedCount++;
                    }
                    if (data.timerStats) {
                        localStorage.setItem(targetPrefix + 'timerStats', JSON.stringify(data.timerStats));
                        importedCount++;
                    }
                    
                    var msg = '‚úÖ Sikeresen import√°lva ' + importedCount + ' adatt√≠pus!';
                    if (data.isMigration) {
                        msg += '\n\n‚ÑπÔ∏è Ezek migr√°lt r√©gi adatok.';
                    }
                    
                    // Automatikusan felt√∂lt√©s Firebase-be
                    syncImportedDataToFirebase(data);
                    
                    msg += '\nK√©rlek, t√∂ltsd √∫jra az oldalt.';
                    
                    alert(msg);
                    
                } catch (err) {
                    console.error('Import hiba:', err);
                    alert('‚ùå JSON hiba: ' + err.message + '\n\nNyisd meg a konzolt (F12) a r√©szletek√©rt!');
                }
            };
            reader.onerror = function() {
                alert('‚ùå Hiba a f√°jl olvas√°sakor!');
            };
            reader.readAsText(file);
        }
        
        function importData() {
            var jsonStr = document.getElementById('importData').value.trim();
            
            if (!jsonStr) {
                alert('‚ùå Kerlek, illeszd be az exportalt adatokat!');
                return;
            }
            
            try {
                var data = JSON.parse(jsonStr);
                console.log('JSON parse OK, kulcsok:', Object.keys(data));
                
                // Ellen≈ërizz√ºk a form√°tumot
                var isValidFormat = data.version || data.gradeTracker || data.assignments || data.grades;
                
                if (!isValidFormat) {
                    // Lehet, hogy hi√°nyzik a z√°r√≥ } - pr√≥b√°ljuk meg jav√≠tani
                    try {
                        var fixedJson = jsonStr + '}';
                        data = JSON.parse(fixedJson);
                        console.log('JSON jav√≠tva, kulcsok:', Object.keys(data));
                        isValidFormat = data.version || data.gradeTracker || data.assignments || data.grades;
                    } catch(e2) {
                        // Nem siker√ºlt jav√≠tani
                    }
                }
                
                if (!isValidFormat) {
                    alert('‚ùå Ismeretlen form√°tum! A f√°jl nem t≈±nik √©rv√©nyes exportnak.');
                    return;
                }
                
                // Double-encoded jav√≠t√°s
                fixDoubleEncoded(data);
                
                if (!confirm('‚ö†Ô∏è Ez felulirhatja a jelenlegi adatokat! Biztosan folytatod?')) {
                    return;
                }
                
                var targetPrefix = '';
                var targetUsername = 'imported';
                
                // Ha bejelentkezett felhasznalo, ahhoz importalunk
                // Ugyanazt a hash-t haszn√°ljuk mint a grade-tracker.js
                if (window.authManager && window.authManager.currentUser) {
                    targetUsername = window.authManager.currentUser.username;
                    const username = window.authManager.currentUser.username;
                    let hash = 0;
                    for (let i = 0; i < username.length; i++) {
                        const char = username.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }
                    const hashStr = Math.abs(hash).toString(36);
                    targetPrefix = 'studyhub_' + hashStr + '_';
                    console.log('üîê Username:', username, 'Hash:', hashStr, 'Prefix:', targetPrefix);
                }
                
                // Importalas - mindig a bejelentkezett felhasznalohoz
                // K√∂zvetlen√ºl mentj√ºk a gradeTracker tartalmat
                console.log('üì• Import data - gradeTracker:', data.gradeTracker ? 'van' : 'nincs');
                console.log('üìÅ Target prefix:', targetPrefix);
                
                if (data.gradeTracker) {
                    const storageKey = targetPrefix + 'gradeTracker';
                    localStorage.setItem(storageKey, JSON.stringify(data.gradeTracker));
                    console.log('‚úÖ Mentve:', storageKey, '- jegyek:', data.gradeTracker.grades?.length || 0);
                }
                if (data.assignments) {
                    localStorage.setItem(targetPrefix + 'assignments', JSON.stringify(data.assignments));
                }
                if (data.quizzes) {
                    localStorage.setItem(targetPrefix + 'quizzes', JSON.stringify(data.quizzes));
                }
                if (data.timerSettings) {
                    localStorage.setItem(targetPrefix + 'timerSettings', JSON.stringify(data.timerSettings));
                }
                if (data.timerStats) {
                    localStorage.setItem(targetPrefix + 'timerStats', JSON.stringify(data.timerStats));
                }
                
                var msg = '‚úÖ Adatok sikeresen importalva!';
                if (data.isMigration) {
                    msg += '\n\n‚ÑπÔ∏è Ezek migralt regi adatok.';
                }
                
                // Automatikusan felt√∂lt√©s Firebase-be
                syncImportedDataToFirebase(data);
                
                msg += '\nK√©rlek, toltsd ujra az oldalt.';
                
                alert(msg);
                
            } catch (e) {
                console.error('Import hiba:', e);
                alert('‚ùå Hib√°s JSON form√°tum: ' + e.message + '\n\nPr√≥b√°ld meg a f√°jlt k√∂zvetlen√ºl bet√∂lteni a "üìÇ Bet√∂lt√©s f√°jlb√≥l" gombbal!');
            }
        }
        
        function clearAllData() {
            if (!confirm('‚ö†Ô∏è Biztosan torlod az osszes helyi adatot? Ez nem vonhato vissza!')) {
                return;
            }
            
            var targetPrefix = '';
            
            // Ha bejelentkezett felhasznalo, azt toroljuk
            if (window.authManager && window.authManager.currentUser) {
                targetPrefix = 'studyhub_' + window.authManager.simpleHash(window.authManager.currentUser.username) + '_';
            }
            
            var keysToRemove = [];
            for (var i = 0; i < localStorage.length; i++) {
                var key = localStorage.key(i);
                if (key) {
                    // Vagy a felhasznalo prefixet, vagy az osszes regi kulcsot
                    if (targetPrefix && key.startsWith(targetPrefix)) {
                        keysToRemove.push(key);
                    } else if (!targetPrefix && (key === 'gradeTracker' || key === 'assignments' || key === 'quizzes' || key === 'timer' || key.startsWith('studyhub_'))) {
                        keysToRemove.push(key);
                    }
                }
            }
            
            keysToRemove.forEach(function(key) {
                localStorage.removeItem(key);
            });
            
            alert('‚úÖ Osszes adat torolve! Kerlek, toltsd ujra az oldalt.');
        }

        /**
         * Import√°lt adatok automatikus felt√∂lt√©se Firebase-be
         */
        function syncImportedDataToFirebase(data) {
            try {
                if (typeof firebase === 'undefined' || !firebase.firestore) {
                    console.warn('‚ö†Ô∏è Firebase nem el√©rhet≈ë, nem tudunk szinkroniz√°lni');
                    return;
                }

                // V√°rjunk az auth-ra
                const checkAndSync = () => {
                    const user = firebase.auth().currentUser;
                    if (!user) {
                        console.warn('‚ö†Ô∏è Nincs bejelentkezett felhaszn√°l√≥, Firebase sync kimarad');
                        return;
                    }

                    const db = firebase.firestore();
                    const uid = user.uid;
                    const promises = [];

                    // Jegyek felt√∂lt√©se
                    if (data.gradeTracker) {
                        console.log('‚òÅÔ∏è Jegyek felt√∂lt√©se Firebase-be...', data.gradeTracker.grades?.length || 0, 'jegy');
                        promises.push(
                            db.collection('grades').doc(uid).set({
                                data: data.gradeTracker,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                userEmail: user.email || ''
                            })
                        );
                    }

                    // Beadand√≥k felt√∂lt√©se
                    if (data.assignments) {
                        console.log('‚òÅÔ∏è Beadand√≥k felt√∂lt√©se Firebase-be...');
                        promises.push(
                            db.collection('assignments').doc(uid).set({
                                assignments: data.assignments,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                userEmail: user.email || ''
                            })
                        );
                    }

                    // Kv√≠zek felt√∂lt√©se
                    if (data.quizzes) {
                        console.log('‚òÅÔ∏è Kv√≠zek felt√∂lt√©se Firebase-be...');
                        promises.push(
                            db.collection('quizzes').doc(uid).set({
                                quizzes: data.quizzes,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                userEmail: user.email || ''
                            })
                        );
                    }

                    Promise.all(promises)
                        .then(() => {
                            console.log('‚úÖ Minden adat sikeresen felt√∂ltve Firebase-be!');
                        })
                        .catch(error => {
                            console.warn('‚ö†Ô∏è Firebase sync hiba:', error.message);
                        });
                };

                // Ha m√°r van user, azonnal szinkroniz√°lunk
                if (firebase.auth().currentUser) {
                    checkAndSync();
                } else {
                    // K√ºl√∂nben v√°rjuk meg az auth-ot
                    const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                        if (user) {
                            checkAndSync();
                            unsubscribe();
                        }
                    });
                    // Timeout: 10 mp
                    setTimeout(() => {
                        unsubscribe();
                    }, 10000);
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Firebase sync hiba:', e.message);
            }
        }
    </script>
</body>
</html>
